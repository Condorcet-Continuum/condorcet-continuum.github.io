---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';

export async function getStaticPaths() {
  const docsEntries = await getCollection('docs');
  return docsEntries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

// 1. Récupération
const allDocs = await getCollection('docs');

// 2. Configuration de l'ordre des groupes
const GROUPS_ORDER = [
  'Général',
  'WORKFLOW_ENGINE',
  'MODEL_ENGINE',
  'RULES_ENGINE',
  'AI',
  'TRACEABILITY',
  'PLUGINS',
  'GENETICS',
  'CODE_GENERATOR',
  'JSON_DB',
  'GRAPH_STORE',
  'BLOCKCHAIN',
  'STORAGE',
  'UTILS',
  'COMMANDS',
];

// 3. Construction de l'Arbre basé sur 'sidebar_parent'
type TreeNode = {
  title: string;
  slug: string;
  doc: CollectionEntry<'docs'>;
  children: TreeNode[];
  order: number;
};

// Map temporaire pour retrouver les noeuds par leur TITRE (ex: "Nlp")
const nodesByTitle: Record<string, TreeNode> = {};
const rootNodesByGroup: Record<string, TreeNode[]> = {};

// Initialisation des noeuds
allDocs.forEach((doc) => {
  const data = doc.data as any;
  const node: TreeNode = {
    title: data.title,
    slug: doc.slug,
    doc: doc,
    children: [],
    order: data.order || 0,
  };
  // On indexe par titre pour que les enfants puissent retrouver leur parent
  // Attention : Il faut que le titre dans le markdown corresponde au 'sidebar_parent'
  nodesByTitle[data.title] = node;
});

// Assemblage de l'arbre
allDocs.forEach((doc) => {
  const data = doc.data as any;
  const group = data.sidebar_group || 'Général';
  const parentTitle = data.sidebar_parent;
  const node = nodesByTitle[data.title];

  if (parentTitle && nodesByTitle[parentTitle]) {
    // Si j'ai un parent connu, je m'ajoute à ses enfants
    nodesByTitle[parentTitle].children.push(node);
  } else {
    // Sinon, je suis une racine de mon groupe
    if (!rootNodesByGroup[group]) rootNodesByGroup[group] = [];
    rootNodesByGroup[group].push(node);
  }
});

// Tri des groupes et des noeuds
const sortedGroups = Object.keys(rootNodesByGroup).sort((a, b) => {
  const indexA = GROUPS_ORDER.indexOf(a);
  const indexB = GROUPS_ORDER.indexOf(b);
  if (indexA === -1 && indexB === -1) return a.localeCompare(b);
  if (indexA === -1) return 1;
  if (indexB === -1) return -1;
  return indexA - indexB;
});

const sortNodes = (nodes: TreeNode[]) => {
  nodes.sort((a, b) => a.title.localeCompare(b.title));
  nodes.forEach((n) => sortNodes(n.children)); // Tri récursif
};
Object.values(rootNodesByGroup).forEach((groupNodes) => sortNodes(groupNodes));

// Helper style
const getLinkClass = (docSlug: string, currentSlug: string, level: number) => {
  const isActive = docSlug === currentSlug;
  const pMap: Record<number, string> = { 1: 'pl-4', 2: 'pl-8', 3: 'pl-12' };
  const padding = pMap[level] || 'pl-4';
  const base = `block py-1 text-sm border-l-2 transition-colors duration-200 ${padding}`;
  if (isActive) return `${base} border-rust text-rust font-bold`;
  return `${base} border-transparent text-slate-600 hover:text-slate-900`;
};
---

<!doctype html>
<html lang="fr" class="scroll-smooth">
  <head>
    <BaseHead title={`${entry.data.title} | Documentation`} description="Doc" />
  </head>
  <body class="bg-slate-50 text-slate-900 font-sans antialiased">
    <Header />

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 flex flex-col md:flex-row gap-12">
      <aside class="md:w-64 shrink-0">
        <nav
          id="sidebar-nav"
          class="sticky top-32 max-h-[80vh] overflow-y-auto pr-2 custom-scrollbar"
        >
          <h3 class="font-bold text-slate-900 mb-8 uppercase tracking-widest text-xs">
            Menu Documentation
          </h3>

          {
            sortedGroups.map((group) => (
              <div class="mb-8">
                <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 ml-4">
                  {group}
                </h4>

                <ul class="space-y-1 border-l border-slate-200 ml-4">
                  {rootNodesByGroup[group].map((node) => (
                    <li>
                      {/* Niveau 1 */}
                      <a href={`/docs/${node.slug}`} class={getLinkClass(node.slug, entry.slug, 1)}>
                        {node.title}
                      </a>

                      {/* Niveau 2 */}
                      {node.children.length > 0 && (
                        <ul class="space-y-1 mt-1 border-l border-slate-100 ml-4">
                          {node.children.map((child) => (
                            <li>
                              <a
                                href={`/docs/${child.slug}`}
                                class={getLinkClass(child.slug, entry.slug, 2)}
                              >
                                {child.title}
                              </a>

                              {/* Niveau 3 */}
                              {child.children.length > 0 && (
                                <ul class="space-y-1 mt-1 border-l border-slate-100 ml-2">
                                  {child.children.map((subChild) => (
                                    <li>
                                      <a
                                        href={`/docs/${subChild.slug}`}
                                        class={getLinkClass(subChild.slug, entry.slug, 3)}
                                      >
                                        {subChild.title}
                                      </a>
                                    </li>
                                  ))}
                                </ul>
                              )}
                            </li>
                          ))}
                        </ul>
                      )}
                    </li>
                  ))}
                </ul>
              </div>
            ))
          }
        </nav>
      </aside>

      <main class="flex-1 min-w-0">
        <article
          class="prose prose-slate max-w-none prose-headings:font-bold prose-headings:text-slate-900 prose-a:text-rust prose-code:text-rust prose-pre:bg-slate-900 prose-pre:shadow-xl rounded-xl"
        >
          <h1 class="text-4xl font-extrabold mb-4">{entry.data.title}</h1>
          <Content />
        </article>
      </main>
    </div>
    <Footer />

    <script is:inline>
      const sidebar = document.getElementById('sidebar-nav');
      const savedPosition = sessionStorage.getItem('sidebar-scroll-pos');
      if (sidebar) {
        if (savedPosition) sidebar.scrollTop = parseInt(savedPosition, 10);
        else {
          const active = sidebar.querySelector('.text-rust');
          if (active) active.scrollIntoView({ block: 'center' });
        }
        sidebar.addEventListener('scroll', () =>
          sessionStorage.setItem('sidebar-scroll-pos', sidebar.scrollTop),
        );
      }
    </script>
  </body>
</html>
